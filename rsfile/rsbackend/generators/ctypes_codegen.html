<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.3.7: http://docutils.sourceforge.net/" />
<title>README: ctypes code generation</title>
<link rel="stylesheet" href="default.css" type="text/css" />
</head>
<body>
<div class="document" id="readme-ctypes-code-generation">
<h1 class="title">README: ctypes code generation</h1>
<p>This document describes the ctypes code generator.  The generator
converts declarations in C header files into executable Python code:
enums, structs, unions, function declarations, com interfaces, and
preprocessor definitions.</p>
<p><strong>The code generator is brand new and still experimental, although
hopefully better than in the 0.9.5 release.</strong></p>
<div class="contents topic" id="contents">
<p class="topic-title first"><a name="contents">Contents</a></p>
<ul class="simple">
<li><a class="reference" href="#overview" id="id1" name="id1">Overview</a></li>
<li><a class="reference" href="#requirements" id="id2" name="id2">Requirements</a></li>
<li><a class="reference" href="#changes-in-the-ctypes-0-9-6-release" id="id3" name="id3">Changes in the ctypes 0.9.6 release</a></li>
<li><a class="reference" href="#usage-examples" id="id4" name="id4">Usage examples</a></li>
<li><a class="reference" href="#the-h2xml-py-script" id="id5" name="id5">The h2xml.py script</a><ul>
<li><a class="reference" href="#the-h2xml-cfg-configuration-file" id="id6" name="id6">The h2xml.cfg configuration file</a></li>
</ul>
</li>
<li><a class="reference" href="#the-xml2py-py-script" id="id7" name="id7">The xml2py.py script</a></li>
<li><a class="reference" href="#getting-help" id="id8" name="id8">Getting Help</a></li>
</ul>
</div>
<div class="section" id="overview">
<h1><a class="toc-backref" href="#id1" name="overview">Overview</a></h1>
<p>Creating wrappers for C header file(s) is a two step process.  First,
the <tt class="docutils literal"><span class="pre">h2xml.py</span></tt> script runs <a class="reference" href="http://www.gccxml.org/">GCC-XML</a> over the include file(s),
creating a XML file containing declarations and definitions.  Second,
the <tt class="docutils literal"><span class="pre">xml2py.py</span></tt> script parses the XML files and creates Python code
containing all or a subset of these definitions.</p>
<p>Python code is generated for C enums, structure, unions, typedefs and
function declarations.  Also included are preprocessor definitions, as
far as they can be converted to valid Python code.</p>
<p>It is possible to filter the output so that only a subset of the
definitions are converted, so it is either possible to generate a
complete Python module wrapping a shared library, or the generator can
be used to create snippets of Python code which can be pasted into a
manually written module.</p>
</div>
<div class="section" id="requirements">
<h1><a class="toc-backref" href="#id2" name="requirements">Requirements</a></h1>
<p><a class="reference" href="http://www.gccxml.org/">GCC-XML</a> (from <a class="reference" href="http://www.gccxml.org/">http://www.gccxml.org/</a>) is required to parse C header
files into an XML description.  <strong>Unfortunately the latest official
version 0.6.0 does not fulfill the ctypes code generator
requirements.</strong></p>
<p>For windows, you can download a prebuild <a class="reference" href="http://sourceforge.net/project/showfiles.php?group_id=71702&amp;package_id=71318&amp;release_id=313813">GCC-XML windows installer</a>
from <a class="reference" href="http://sourceforge.net/project/showfiles.php?group_id=71702">the ctypes download page</a> (this is an unofficial release).
Please note that even the <em>installation</em> of GCC-XML requires that MSVC
6, 7, or 7.1 is installed on your system, because it needs the system
header files.</p>
<p>For other platforms you must <a class="reference" href="http://www.gccxml.org/HTML/Download.html">get the development version from CVS</a>
and <a class="reference" href="http://www.gccxml.org/HTML/Install.html">build GCC-XML from source</a>.</p>
</div>
<div class="section" id="changes-in-the-ctypes-0-9-6-release">
<h1><a class="toc-backref" href="#id3" name="changes-in-the-ctypes-0-9-6-release">Changes in the ctypes 0.9.6 release</a></h1>
<blockquote>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">h2xml.py</span></tt> doesn't try to find preprocessor definitions by default
anymore.  Can be changed with the new <tt class="docutils literal"><span class="pre">-c</span></tt> or <tt class="docutils literal"><span class="pre">--cpp-symbols</span></tt>
flag.</li>
<li>Added <tt class="docutils literal"><span class="pre">-k</span></tt> option to <tt class="docutils literal"><span class="pre">h2xml.py</span></tt> to not delete temporary
files.</li>
<li>Better error output if the compilation fails.</li>
<li><tt class="docutils literal"><span class="pre">h2xml.py</span></tt> can load an optional local configuration file from the
current directory</li>
<li>several bugs in the gccxml installer plus one bug in gccxml has been fixed,
and the gccxml installer snapshot has been rebuilt.</li>
</ul>
</blockquote>
</div>
<div class="section" id="usage-examples">
<h1><a class="toc-backref" href="#id4" name="usage-examples">Usage examples</a></h1>
<p>Here are several examples that show how to call the <tt class="docutils literal"><span class="pre">h2xml.py</span></tt> and
<tt class="docutils literal"><span class="pre">xml2py.py</span></tt> scripts, and the code they generate.  The output has
sometimes been cleaned up a bit, for clarity.  Generally, the
codegenerator creates a lot of comments pointing to the C header file.
This is useful to quickly look up the C source code.</p>
<p>Parse the windows header files (this may take a while), and include
preprocessor definitions in the xml file:</p>
<pre class="literal-block">
C:\&gt;python h2xml.py windows.h -o windows.xml -q -c
C:\&gt;
</pre>
<p>Generate code for the <tt class="docutils literal"><span class="pre">RECT</span></tt> structure:</p>
<pre class="literal-block">
C:\&gt;xml2py.py windows.xml -s RECT
from ctypes import *
LONG = c_long
class tagRECT(Structure):
    pass
RECT = tagRECT
tagRECT._fields_ = [
    ('left', c_long),
    ('top', c_long),
    ('right', c_long),
    ('bottom', c_long),
]
assert sizeof(tagRECT) == 16, sizeof(tagRECT)
assert alignment(tagRECT) == 4, alignment(tagRECT)
C:\&gt;
</pre>
<p>Generate the <tt class="docutils literal"><span class="pre">MB_xxx</span></tt> constants, which are flags used for the
<tt class="docutils literal"><span class="pre">MessageBox</span></tt> function - since these are #define'd symbols this works
only when the xml file includes preprocessor definitions:</p>
<pre class="literal-block">
c:\&gt;python xml2py.py windows.xml -r MB_.*
# generated by 'xml2py.py'
# flags 'windows.xml -r MB_.*'
MB_USERICON = 128
MB_DEFBUTTON3 = 512
MB_USEGLYPHCHARS = 4
MB_ABORTRETRYIGNORE = 2
MB_ICONASTERISK = 64
MB_ICONINFORMATION = MB_ICONASTERISK
MB_ICONHAND = 16
MB_ICONERROR = MB_ICONHAND
MB_ICONEXCLAMATION = 48
MB_ICONWARNING = MB_ICONEXCLAMATION
MB_RIGHT = 524288
MB_SYSTEMMODAL = 4096
MB_ICONQUESTION = 32
MB_APPLMODAL = 0
MB_OK = 0
MB_TYPEMASK = 15
MB_MODEMASK = 12288
MB_TASKMODAL = 8192
MB_OKCANCEL = 1
MB_RETRYCANCEL = 5
MB_DEFAULT_DESKTOP_ONLY = 131072
MB_RTLREADING = 1048576
MB_PRECOMPOSED = 1
MB_DEFBUTTON1 = 0
MB_DEFMASK = 3840
MB_DEFBUTTON2 = 256
MB_YESNOCANCEL = 3
MB_CANCELTRYCONTINUE = 6
MB_HELP = 16384
MB_ICONMASK = 240
MB_SETFOREGROUND = 65536
MB_TOPMOST = 262144
MB_COMPOSITE = 2
MB_DEFBUTTON4 = 768
MB_YESNO = 4
MB_ERR_INVALID_CHARS = 8
MB_NOFOCUS = 32768
MB_ICONSTOP = MB_ICONHAND
MB_MISCMASK = 49152
C:\&gt;
</pre>
<p>Generate code for the <tt class="docutils literal"><span class="pre">RegisterClass</span></tt> function, note how this pulls
in a lot of types (if you want code compatible with Python 2.3 don't
use the <tt class="docutils literal"><span class="pre">-d</span></tt> flag):</p>
<pre class="literal-block">
C:\&gt;python xml2py.py windows.xml -w -s RegisterClass -d
# generated by 'xml2py'
# flags 'windows.xml -w -s RegisterClass'
from ctypes import *
from ctypes import decorators

WORD = c_ushort
ATOM = WORD
class tagWNDCLASSA(Structure):
    pass
WNDCLASSA = tagWNDCLASSA

&#64; decorators.stdcall(ATOM, 'user32', [POINTER(WNDCLASSA)])
def RegisterClassA(p1):
    return RegisterClassA._api_(p1)

RegisterClass = RegisterClassA
UINT = c_uint
LONG_PTR = c_long
LRESULT = LONG_PTR
WNDPROC = WINFUNCTYPE(LRESULT, c_void_p, c_uint, c_uint, c_long)
PVOID = c_void_p
HANDLE = PVOID
HINSTANCE = HANDLE
HICON = HANDLE
HCURSOR = HICON
HBRUSH = HANDLE
CHAR = c_char
LPCSTR = POINTER(CHAR)
tagWNDCLASSA._fields_ = [
    ('style', UINT),
    ('lpfnWndProc', WNDPROC),
    ('cbClsExtra', c_int),
    ('cbWndExtra', c_int),
    ('hInstance', HINSTANCE),
    ('hIcon', HICON),
    ('hCursor', HCURSOR),
    ('hbrBackground', HBRUSH),
    ('lpszMenuName', LPCSTR),
    ('lpszClassName', LPCSTR),
]
assert sizeof(tagWNDCLASSA) == 40, sizeof(tagWNDCLASSA)
assert alignment(tagWNDCLASSA) == 4, alignment(tagWNDCLASSA)
</pre>
<p>Generate code for the <tt class="docutils literal"><span class="pre">ICreateErrorInfo</span></tt> com interface.  This
example uses the <tt class="docutils literal"><span class="pre">-m</span></tt> command line flag, and the generated code
imports several symbols from the specified <tt class="docutils literal"><span class="pre">ctypes.com</span></tt> module.
Note that the <tt class="docutils literal"><span class="pre">_iid_</span></tt> member of the interface cannot be created by
the code generator, but the generated comments allows to quickly locate
the header file and patch this manually:</p>
<pre class="literal-block">
C:\sf\ctypes\ctypes\wrap&gt;xml2py windows.xml -s ICreateErrorInfo -m ctypes.com
# generated by 'xml2py'
# flags 'windows.xml -s ICreateErrorInfo -m ctypes.com'
from ctypes import *
from ctypes.com import IUnknown
from ctypes.com import GUID
class ICreateErrorInfo(IUnknown):
    _iid_ = GUID('{}') # please look up iid and fill in!
    # C:/Programme/gccxml/bin/Vc71/PlatformSDK/oaidl.h 5366
    pass
from ctypes.com import HRESULT
from ctypes.com import GUID
WCHAR = c_wchar
OLECHAR = WCHAR
LPOLESTR = POINTER(OLECHAR)
from ctypes.com import DWORD
from ctypes.com import STDMETHOD
ICreateErrorInfo._methods_ = IUnknown._methods + [
# C:/Programme/gccxml/bin/Vc71/PlatformSDK/oaidl.h 5366
    STDMETHOD(HRESULT, 'SetGUID', [POINTER(GUID)]),
    STDMETHOD(HRESULT, 'SetSource', [LPOLESTR]),
    STDMETHOD(HRESULT, 'SetDescription', [LPOLESTR]),
    STDMETHOD(HRESULT, 'SetHelpFile', [LPOLESTR]),
    STDMETHOD(HRESULT, 'SetHelpContext', [DWORD]),
]
</pre>
<p>Create a Python module <tt class="docutils literal"><span class="pre">win_lean.py</span></tt> containing wrappers for the
'lean' windows api, this creates a fairly large file:</p>
<pre class="literal-block">
C:\&gt;python h2xml.py windows.h -D WIN32_LEAN_AND_MEAN -D NO_STRICT -o win_lean.xml -q
C:\&gt;python xml2py.py win_lean.xml -w -o win_lean.py
</pre>
<p>Create a Python module <tt class="docutils literal"><span class="pre">SDL.py</span></tt> containing wrappers for the <tt class="docutils literal"><span class="pre">SDL</span></tt>
library.  To work around a problem GCC-XML has with a certain construct
in the SDL header files on Windows, you must define the <tt class="docutils literal"><span class="pre">SDLCALL</span></tt>
macro to an empty value:</p>
<pre class="literal-block">
C:\&gt;python h2xml.py SDL.h -I SDL\include -D SDLCALL= -o SDL.xml -q
C:\&gt;python xml2py.py SDL.xml -o SDL.py -l SDL.dll
C:\&gt;
</pre>
<p>On linux, the <tt class="docutils literal"><span class="pre">SDL.py</span></tt> module could be created in this way - both
the location of the include file and the name of the shared library is
different:</p>
<pre class="literal-block">
thomas&#64;linux:~/ctypes/wrap&gt; locate SDL.h
/usr/include/SDL/SDL.h
thomas&#64;linux:~/ctypes/wrap&gt; python h2xml.py SDL/SDL.h -o SDL.xml -q
thomas&#64;linux:~/ctypes/wrap&gt; python xml2py.py SDL.xml -o SDL.py -l libSDL.so
thomas&#64;linux:~/ctypes/wrap&gt; ls -l SDL.py
-rw-r--r--    1 thomas   users       95772 2004-10-26 02:23 SDL.py
thomas&#64;linux:~/ctypes/wrap&gt; 
</pre>
</div>
<div class="section" id="the-h2xml-py-script">
<h1><a class="toc-backref" href="#id5" name="the-h2xml-py-script">The h2xml.py script</a></h1>
<p><tt class="docutils literal"><span class="pre">h2xml.py</span></tt> lets you specify the names of the header files to parse,
the name of the XML output file, and a few options which are passed to
GCC-XML.  The <tt class="docutils literal"><span class="pre">-D</span></tt>, <tt class="docutils literal"><span class="pre">-E</span></tt>, and <tt class="docutils literal"><span class="pre">-I</span></tt> flags may occur several times.</p>
<p><tt class="docutils literal"><span class="pre">-h,</span> <span class="pre">--help</span></tt></p>
<blockquote>
Print a short usage summary and exit.</blockquote>
<p><tt class="docutils literal"><span class="pre">-q,</span> <span class="pre">--quiet</span></tt></p>
<blockquote>
Run in quiet mode.  The default mode is verbose, <tt class="docutils literal"><span class="pre">h2xml.py</span></tt> prints
what it is currently doing.</blockquote>
<p><tt class="docutils literal"><span class="pre">-D</span> <span class="pre">name[=value]</span></tt></p>
<blockquote>
This flag defines a preprocessor name.</blockquote>
<p><tt class="docutils literal"><span class="pre">-U</span> <span class="pre">name</span></tt></p>
<blockquote>
This flag undefines a preprocessor name.</blockquote>
<p><tt class="docutils literal"><span class="pre">-I</span> <span class="pre">directory</span></tt></p>
<blockquote>
This flag defines an additional include directory.</blockquote>
<p><tt class="docutils literal"><span class="pre">-o</span> <span class="pre">xmlfile</span></tt></p>
<blockquote>
This flag specifies name and path of the XML output file.</blockquote>
<p><tt class="docutils literal"><span class="pre">-c,</span> <span class="pre">--cpp-symbols</span></tt></p>
<blockquote>
Run additional magic to include #define symbols in the xml output.
Depending on the madness in the header files this may or may not
work.</blockquote>
<p><tt class="docutils literal"><span class="pre">-k</span></tt></p>
<blockquote>
Do not delete temporary files created - this may be useful to find
compilation problems.</blockquote>
<div class="section" id="the-h2xml-cfg-configuration-file">
<h2><a class="toc-backref" href="#id6" name="the-h2xml-cfg-configuration-file">The h2xml.cfg configuration file</a></h2>
<p>If you enable preprocessor definition processing with the <tt class="docutils literal"><span class="pre">-c</span></tt> flag,
it is possible that you get compiler errors on certain symbols.  In
this case, it is needed to exclude those symbols by writing in local
configuration file named <tt class="docutils literal"><span class="pre">h2xml.cfg</span></tt> in the current directory.  The
configuration file sections are named after <tt class="docutils literal"><span class="pre">sys.platform</span></tt>, and it
allows to specify the symbols to exclude by names or by regular
expressions:</p>
<pre class="literal-block">
# h2xml.cfg
#
# config file for h2xml script
#
# sections should be named after 'sys.platform'
# options supported are:
# 'excluded' - names of preprocessor symbols to exclude,
#         separated by whitespace
# 'excluded_re' - regular expressions, separated by whitespace, matching
#         cpp symbols to exclude
# See the documentation of the standard Python ConfigParser module
# for maore information on the file format.

[win32]
excluded = foo bar
excluded_re = spam.* .*spam

[cygwin]
excluded =
excluded_re =

[linux2]
excluded =
excluded_re =

[darwin]
excluded =
excluded_re =

[freebsd5]
excluded =
excluded_re =
</pre>
</div>
</div>
<div class="section" id="the-xml2py-py-script">
<h1><a class="toc-backref" href="#id7" name="the-xml2py-py-script">The xml2py.py script</a></h1>
<p><tt class="docutils literal"><span class="pre">-h,</span> <span class="pre">--help</span></tt></p>
<blockquote>
Print a short usage summary and exit.</blockquote>
<p><tt class="docutils literal"><span class="pre">-d</span></tt></p>
<blockquote>
Use Python 2.4 decorators for wrapped functions.</blockquote>
<p><tt class="docutils literal"><span class="pre">-k[d][e][f][m][s][t]</span></tt></p>
<blockquote>
<p>Specifies the kind of types to include in the output:</p>
<p><tt class="docutils literal"><span class="pre">d</span></tt> - simple preprocessor definitions: #define &lt;identifier&gt; &lt;identifier&gt;</p>
<p><tt class="docutils literal"><span class="pre">e</span></tt> - enumerations</p>
<p><tt class="docutils literal"><span class="pre">f</span></tt> - function declarations</p>
<p><tt class="docutils literal"><span class="pre">m</span></tt> - preprocessor macros taking parameters: #define &lt;ident&gt;(parameters) something</p>
<p><tt class="docutils literal"><span class="pre">s</span></tt> - structures and unions</p>
<p><tt class="docutils literal"><span class="pre">t</span></tt> - typedefs</p>
</blockquote>
<p><tt class="docutils literal"><span class="pre">-l</span> <span class="pre">sharedlib</span></tt></p>
<blockquote>
specify shared library to search for exported functions.</blockquote>
<p><tt class="docutils literal"><span class="pre">-m</span> <span class="pre">module</span></tt></p>
<blockquote>
specifies a Python module containing symbols that will be imported
instead of generated.</blockquote>
<p><tt class="docutils literal"><span class="pre">-o</span> <span class="pre">outputfile</span></tt></p>
<blockquote>
name of the output file containing Python code.  If not specified,
the code is printed to standard output.</blockquote>
<p><tt class="docutils literal"><span class="pre">-r</span> <span class="pre">regular_expression</span></tt></p>
<blockquote>
regular expression specifying names of symbols to include.</blockquote>
<p><tt class="docutils literal"><span class="pre">-s</span> <span class="pre">symbol</span></tt></p>
<blockquote>
name of symbol to include.</blockquote>
<p><tt class="docutils literal"><span class="pre">-v</span></tt></p>
<blockquote>
verbose mode: prints a short summary of types generated.</blockquote>
<p><tt class="docutils literal"><span class="pre">-w</span></tt></p>
<blockquote>
windows only: add all standard windows dlls to the list of shared
libraries searched for functions.</blockquote>
<p>Note that specifying the <tt class="docutils literal"><span class="pre">-k</span></tt>, <tt class="docutils literal"><span class="pre">-s</span></tt>, and <tt class="docutils literal"><span class="pre">-r</span></tt> flags create a
start set of type declarations, the generated code, however, may also
contain other types.  If, for example, the code for an external
function is generated, code for the argument and return types is also
needed.</p>
<p>Also note that code for function declarations is only created when
<tt class="docutils literal"><span class="pre">xml2py.py</span></tt> can locate the function in one of the shared libraries
specified with <tt class="docutils literal"><span class="pre">-l</span></tt> or <tt class="docutils literal"><span class="pre">-w</span></tt>.</p>
</div>
<div class="section" id="getting-help">
<h1><a class="toc-backref" href="#id8" name="getting-help">Getting Help</a></h1>
<p>If you have questions or need assistance with <em>ctypes</em> or
the code generator, please <a class="reference" href="mailto:ctypes-users&#64;lists.sourceforge.net">post a message</a> to the <a class="reference" href="http://lists.sourceforge.net/lists/listinfo/ctypes-users">ctypes-users
mailing list</a>.</p>
<!-- Local Variables:
mode: indented-text
indent-tabs-mode: nil
sentence-end-double-space: t
fill-column: 70
compile-command: "make"
End: -->
</div>
</div>
<hr class="docutils footer" />
<div class="footer">
<a class="reference" href="codegen.txt">View document source</a>.
Generated on: 2005-03-18 19:21 UTC.
Generated by <a class="reference" href="http://docutils.sourceforge.net/">Docutils</a> from <a class="reference" href="http://docutils.sourceforge.net/rst.html">reStructuredText</a> source.
</div>
</body>
</html>
